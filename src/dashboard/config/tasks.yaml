query_building_task:
  description: >
    Generate AND execute an optimized MongoDB aggregation pipeline for: "{user_query}"

    Context: DineLytics (food delivery app, Buffalo). MongoDB URI: {mongodb_uri}, DB: {database_name}, Collections: {collection_names}, Today: {current_date}

    DATABASE SCHEMAS:
    {database_schemas}

    SCHEMA NOTES:
    - orders.total_amount = entire order total; orders.details[].total_amount = single item total
    - orders.details[] is an array — use $unwind to access items
    - details[].name = item name, details[].price = unit price, details[].qty = quantity
    - Use case-insensitive regex ($options:'i') for ALL name filters

    FOOD ITEMS: If query mentions specific food (pizza, pasta), use Food Items Finder first. For general queries (top 10, total revenue), build directly — do NOT call any tool.

    DATE RULES:
    - "till now"/"total"/"all time"/no time period = NO date filter, just end_date=datetime.now()
    - "last month" = previous calendar month (e.g. if Dec 21 → Nov 1 to Dec 1)
    - "this month" = current month start to next month start
    - "today" = today only (start to start+1 day)
    - Only add date filters when user explicitly mentions a time period

    STEPS:
    1. Build the Python/pymongo code: connect via os.getenv('mongodb_uri')/os.getenv('database_name'), run pipeline, print json.dumps(results, default=str).
    2. IMMEDIATELY execute the code using the Python Code Executor tool.
    3. Return both the code AND the execution output.

  expected_output: >
    The python_code you wrote AND the raw JSON execution output from running it.

data_analysis_task:
  description: >
    Format the pre-executed query results from query_building_task for: "{user_query}"

    The query has ALREADY been executed. The raw JSON output is in the context from query_building_task.
    Do NOT re-execute the code unless the results look wrong or empty due to a bug (then fix and re-run).

    FORMAT RULES:
    - Multiple rows → Markdown table (blank line before table, each row on new line)
    - Single metric → concise sentence (e.g. "Total revenue is $12,345.00")
    - No data → polite explanation
    - Month numbers→names, weekly data→date ranges ("Nov 4-10"), financial values with "$", names instead of IDs
    - Never return raw JSON or empty lists
    - Only include items matching user's request

  expected_output: >
    ONLY the direct answer. No technical explanations.
    Single-answer → concise sentence. Multiple rows → Markdown table. No data → brief explanation.
    Format financial values with "$".

  agent: data_analyst
  context:
    - query_building_task
